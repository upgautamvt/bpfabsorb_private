SOURCES := $(wildcard *.kern.c)
FILES := $(SOURCES:.c=.o)
MAP_FINE_SRC := $(wildcard map-fine/*.kern.c)
MAP_FINE_OBJ := $(MAP_FINE_SRC:.c=.o)
MAP_FINE_USER_SRC := $(wildcard map-fine/*.user.c)
MAP_FINE_USER_OBJ := $(MAP_FINE_USER_SRC:.c=)
USER_SRC := $(wildcard *.user.c)
USER := $(USER_SRC:.c=)
BPF-CLANG := clang
BPF_CLANG_CFLAGS := -target bpf -g -Wall -O2 -c
INCLUDE := -I../linux/usr/include/ -I../linux/tools/lib/
USER-CFLAGS := -I../linux/usr/include -I../linux/tools/lib/ -L../linux/tools/lib/bpf/


all: $(FILES) $(USER)
	
test: test.c
	$(BPF-CLANG) $(INCLUDE) $(CFLAGS) -o test test.c

$(FILES) : %.o : %.c
	$(BPF-CLANG) $(INCLUDE) $(CFLAGS) -o $@ $<

$(USER) : % : %.c
	gcc $(USER-CFLAGS) $< -lbpf -o $@

map-fine: $(MAP_FINE_OBJ) $(MAP_FINE_USER_OBJ)

$(MAP_FINE_OBJ) : %.o : %.c
	$(BPF-CLANG) $(INCLUDE) $(CFLAGS) -o $@ $<

$(MAP_FINE_USER_OBJ) : % : %.c
	gcc $(USER-CFLAGS) $< -lbpf -o $@

.PHONY : map-fine-clean
map-fine-clean :
	rm $(MAP_FINE_OBJ) $(MAP_FINE_USER_OBJ)

.PHONY : clean

map-fine-clean:
	rm $(FILES)

clean :
	rm $(FILES) $(USER)
